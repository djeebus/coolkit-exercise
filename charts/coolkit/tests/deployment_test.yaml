suite: deployment tests

templates:
  - deployment.yaml

set:
  image.repository: fathom/coolkit

tests:
  - it: can have args
    set:
      args:
        - one
        - two
    asserts:
      - equal:
          path: spec.template.spec.containers[0].args
          value: [one, two]
  - it: can have an image
    asserts:
      - equal:
          path: spec.template.spec.containers[0].image
          value: fathom/coolkit:latest
  - it: can have an image and tag
    set:
      image.tag: stable
    asserts:
      - equal:
          path: spec.template.spec.containers[0].image
          value: fathom/coolkit:stable
  - it: can have an image with a sha
    set:
      image.tag: stable
      image.hash: sha256:1ff6c18fbef2045af6b9c16bf034cc421a29027b800e4f9b68ae9b1cb3e9ae07
    asserts:
      - equal:
          path: spec.template.spec.containers[0].image
          value: fathom/coolkit:stable@sha256:1ff6c18fbef2045af6b9c16bf034cc421a29027b800e4f9b68ae9b1cb3e9ae07

  - it: can have replica count
    set:
      replicas: 2
    asserts:
      - equal:
          path: spec.replicas
          value: 2

  - it: can have resources
    set:
      resources:
        requests:
          cpu: 500m
          memory: 1Gi
        limits:
          cpu: 1000m
          memory: 2Gi
    asserts:
      - equal:
          path: spec.template.spec.containers[0].resources
          value:
            requests:
              cpu: 500m
              memory: 1Gi
            limits:
              cpu: 1000m
              memory: 2Gi
  - it: can have cloudsql proxy enabled
    set:
      cloudsqlproxy.enabled: true
      cloudsqlproxy.instanceConnectionName: instance-name
    asserts:
      - lengthEqual:
          path: spec.template.spec.initContainers
          count: 1
